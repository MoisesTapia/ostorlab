"""Unit tests for Report Vaulnerability Mixin."""

from ostorlab.agent.mixins import agent_report_vulnerability_mixin
from ostorlab.agent.kb import kb as knowledge_base
from ostorlab.agent import definitions as agent_definitions
from ostorlab.runtimes import definitions as runtime_definitions


def testSendVulnerabilityMessage_whenKbEntryIsValid_Something(agent_mock):
    """Unit test"""
    agent_def = agent_definitions.AgentDefinition(name='some_name', out_selectors=['v3.report.vulnerability'])
    agent_settings = runtime_definitions.AgentSettings(key='some_key')
    report_vul_mixin = agent_report_vulnerability_mixin.AgentReportVulnMixin(agent_def, agent_settings)

    report_vul_mixin.send_vulnerability_message(
        entry=knowledge_base.KB.VIRUSTOTAL_SCAN,
        technical_detail='some_technical_detail',
        risk_rating='HIGH',
        dna='some_dna')

    assert len(agent_mock) == 1
    assert agent_mock[0].selector == 'v3.report.vulnerability'
    assert agent_mock[0].data['short_description'] == 'VirusTotal Malware analysis'
    assert agent_mock[0].data['privacy_issue']
    assert agent_mock[0].data['security_issue']
    assert agent_mock[0].data['references'] == [{'title':'Virustotal', 'url':'https://www.virustotal.com/'}]
